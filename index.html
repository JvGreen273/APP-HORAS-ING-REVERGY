<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Revergy Pro - Panel de Ingenier√≠a</title>
<style>
    /* --- TU CSS ORIGINAL (MANTENIDO 100%) --- */
    :root {
        --primary: #4facfe; --secondary: #00f2fe; --danger: #ff4b2b; --success: #2ecc71;
        --bg-glass: rgba(30, 30, 47, 0.85);
    }
    body{
        font-family:"Segoe UI",Arial; margin:0; padding:20px;
        background: radial-gradient(circle at top right, #1e3c72, #2a5298, #0f0f1a);
        color:#f5f5f5; min-height: 100vh;
    }
    .glass {
        background: var(--bg-glass); backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.1); border-radius: 20px;
        padding: 25px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); margin-bottom: 20px;
    }
    .instruction-box {
        background: rgba(79, 172, 254, 0.1); border-left: 4px solid var(--primary);
        padding: 15px; margin-bottom: 20px; font-size: 0.85em; color: #ccc; text-align: left;
        line-height: 1.4; border-radius: 0 10px 10px 0;
    }
    header{display:flex;align-items:center;gap:20px;margin-bottom:20px;}
    header img{height:60px; filter: drop-shadow(0 0 10px var(--primary));}
    h1,h2,h3{
        background:linear-gradient(90deg, var(--secondary), var(--primary));
        -webkit-background-clip:text; -webkit-text-fill-color:transparent;
    }
    .kpi-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px; }
    .kpi-card { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 15px; text-align: center; border: 1px solid rgba(255,255,255,0.05); }
    .kpi-card span { display: block; font-size: 1.8em; font-weight: bold; color: var(--secondary); }
    .kpi-card label { font-size: 0.8em; color: #aaa; text-transform: uppercase; }
    input, select, textarea {
        width: 100%; padding: 12px; margin: 8px 0; box-sizing: border-box;
        border-radius: 10px; border: 1px solid #444; background: #151525; color: #fff;
    }
    button {
        padding: 12px 24px; border-radius: 25px; border: none; cursor: pointer; font-weight: bold;
        transition: 0.3s; background: linear-gradient(90deg, var(--secondary), var(--primary)); color: #000;
    }
    button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 242, 254, 0.4); }
    .hidden { display: none !important; }
    table { border-collapse: collapse; width: 100%; margin-top: 15px; border-radius: 12px; overflow: hidden; }
    th { background: rgba(79, 172, 254, 0.2); color: var(--secondary); padding: 15px; text-align: left; }
    td { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); background: rgba(0,0,0,0.2); }
    .meta-cumplida { color: var(--success); font-weight: bold; }
    .meta-baja { color: var(--danger); font-weight: bold; }
    .dashboard-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; }
    .chart-box { background: rgba(0,0,0,0.2); padding: 20px; border-radius: 15px; text-align: center; }

    /* --- CAPA EST√âTICA CANVA --- */
    .canvas-wrapper { position: relative; width: 100%; }
    .canva-overlay {
        position: absolute; top: 10px; right: 10px;
        display: flex; flex-direction: column; gap: 8px;
        pointer-events: none; z-index: 10;
    }
    .canva-badge {
        background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        padding: 6px 12px; border-radius: 12px;
        display: flex; justify-content: space-between; align-items: center; gap: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        animation: slideIn 0.5s ease-out;
    }
    .canva-name { font-size: 0.8em; font-weight: 600; color: #fff; }
    .canva-pct { background: var(--primary); color: #000; padding: 2px 6px; border-radius: 6px; font-size: 0.75em; font-weight: bold; }
    @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
</style>
</head>
<body>

<div id="authModule" class="glass" style="max-width: 450px; margin: 40px auto;">
    <h2 style="text-align:center">Panel de Ingenier√≠a</h2>
    <div class="instruction-box">
        <b>üí° Manual Revergy+:</b><br>
        1. <b>Registro:</b> Crea tu cuenta personal. <br>
        2. <b>Seguridad:</b> Roles de PM requieren c√≥digo de autorizaci√≥n corporativo.<br>
        3. <b>Backup:</b> Exporta tus datos para respaldo externo (.json).<br>
        4. <b>Meta:</b> Buscamos 6h diarias independientes.
    </div>
    <div style="display:flex; gap:10px; margin-bottom:20px;">
        <button onclick="switchAuth('login')" id="btnL" style="flex:1">Ingresar</button>
        <button onclick="switchAuth('reg')" id="btnR" style="flex:1; opacity:0.5">Registrarse</button>
    </div>
    <input id="authUser" placeholder="Usuario">
    <input id="authPass" type="password" placeholder="Contrase√±a">
    <div id="regFields" class="hidden">
        <select id="authRol" onchange="toggleSec()">
            <option value="ingeniero">Rol: Ingeniero</option>
            <option value="pm">Rol: Manager / PM</option>
        </select>
        <input id="authCode" class="hidden" type="password" placeholder="C√≥digo de Autorizaci√≥n PM" style="border: 1px solid var(--danger)">
    </div>
    <button onclick="handleAuth()" id="btnMainAuth">Acceder al Portal</button>
</div>

<div id="app" class="hidden">
    <header>
        <img src="13-revergy_reducida.png" alt="Revergy">
        <h1>Control de Ingenier√≠a</h1>
        <div style="margin-left: auto;">
            <button onclick="logout()" style="background:var(--danger); color:#fff; width:auto;">Cerrar Sesi√≥n</button>
        </div>
    </header>

    <div class="kpi-container">
        <div class="kpi-card"><label>Total Horas</label><span id="kpiTotal">0</span></div>
        <div class="kpi-card"><label>D√≠as Cumplidos</label><span id="kpiMeta">0</span></div>
        <div class="kpi-card"><label>Top Proyecto</label><span id="kpiProy" style="font-size:1.1em">-</span></div>
        <div class="kpi-card"><label>Eficiencia Equipo</label><span id="kpiEfi">0%</span></div>
    </div>

    <div class="glass">
        <h3>Cargar Registro</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
            <select id="ingSel"></select>
            <select id="codProy" onchange="actualizarSubmenu()">
                <option value="">C√≥digo Proyecto...</option>
                <option value="CSE-2256613">CSE-2256613</option>
                <option value="CSV-2263319">CSV-2263319</option>
                <option value="005-PTR">005-PTR</option>
                <option value="G639">G639</option>
                <option value="VLTL-01">VLTL-01</option>
                <option value="DD-UNRG">DD-UNRG</option>
                <option value="DD-COX">DD-COX</option>
                <option value="DD-FMO">DD-FMO</option>
                <option value="DD-ATL">DD-ATL</option>
                <option value="DD-KAI">DD-KAI</option>
                <option value="DD-CFM">DD-CFM</option>
                <option value="JNK-MLG-01">JNK-MLG-01</option>
                <option value="EDF-BSL6">EDF-BSL6</option>
                <option value="ING">ING</option>
            </select>
            <select id="codPC">
                <option value="">C√≥digo P+C...</option>
            </select>
            <input id="fecha" type="date">
            <input id="horas" type="number" step="0.1" placeholder="Horas">
            <select id="act">
                <option value="">Actividad...</option>
                <option>Gestion de Proyecto</option><option>Revision de Ingenieria</option>
                <option>Mesas de Trabajo</option><option>Revision Informacion Previa</option>
                <option>Dise√±o de Ingenieria</option><option>Atencion de comentarios</option>
            </select>
            <textarea id="desc" placeholder="Descripci√≥n detallada..." style="grid-column: 1 / -1; height:60px"></textarea>
            <button onclick="save()" style="grid-column: 1 / -1">üíæ Guardar Actividad</button>
        </div>
    </div>

    <div id="pmTools" class="hidden glass">
        <h3>Herramientas de Gesti√≥n (PM)</h3>
        <div style="display: flex; gap:10px; flex-wrap:wrap">
            <select id="fIng" style="width:200px"></select>
            <select id="fProy" style="width:200px"></select>
            <input id="fD" type="date" style="width:150px"><input id="fH" type="date" style="width:150px">
            <button onclick="render()" style="width:auto">Filtrar</button>
        </div>
    </div>

    <div class="glass"><div id="tablaD"></div></div>

    <div class="dashboard-container">
        <div class="chart-box" id="chartIngBox">
            <h3>Horas/Ingeniero</h3>
            <div class="canvas-wrapper">
                <canvas id="cIng" width="400" height="220"></canvas>
                <div id="canvaIng" class="canva-overlay"></div>
            </div>
        </div>
        <div class="chart-box"><h3>Horas/Proyecto</h3><canvas id="cProy" width="400" height="220"></canvas></div>
        <div class="chart-box"><h3>Distribuci√≥n Actividades</h3><canvas id="cAct" width="400" height="220"></canvas></div>
        <div class="chart-box">
            <h3>Tendencia vs Curva S</h3>
            <div class="canvas-wrapper">
                <canvas id="cLine" width="400" height="220"></canvas>
                <div id="canvaS" class="canva-overlay" style="top:auto; bottom:40px; right:10px;"></div>
            </div>
        </div>
    </div>

    <div class="glass" style="margin-top:20px;">
        <h3>üì¶ Gesti√≥n de Datos y Backups</h3>
        <div style="display:flex; gap:10px; flex-wrap:wrap">
            <button onclick="exportarBackup()" style="background:var(--primary); color:#000; width:auto;">üì§ Exportar Respaldo (.json)</button>
            <div id="importZone" style="position:relative; display:inline-block">
                <button style="background:var(--secondary); color:#000; width:auto">üì• Importar y Unir Datos</button>
                <input type="file" onchange="importarBackup(event)" style="position:absolute; left:0; top:0; opacity:0; width:100%; height:100%; cursor:pointer;">
            </div>
            <button onclick="exportXLS()" style="background:var(--success); color:#fff; width:auto;">‚¨á Excel Reporte</button>
            <button onclick="window.print()" style="background:#666; color:#fff; width:auto;">üì∏ Captura PDF</button>
        </div>
    </div>
</div>

<script>
    const $=id=>document.getElementById(id);
    const META = 6; const PM_KEY = "Revergy+";
    const DB_URL = "https://revergypro-default-rtdb.firebaseio.com";

    // --- L√ìGICA CORE (MANTENIDA) ---
    async function syncCloud(nodo, data) {
        try {
            const id = data.id || data.user;
            await fetch(`${DB_URL}/${nodo}/${id}.json`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ...data, sync_ts: new Date().toISOString() })
            });
        } catch (e) { console.warn("Modo Offline"); }
    }

    async function pullCloud() {
        try {
            const rAct = await fetch(`${DB_URL}/actividades.json`);
            const dAct = await rAct.json();
            if(dAct) { dbR = Object.values(dAct); localStorage.setItem("db_registros", JSON.stringify(dbR)); }
            const rUsr = await fetch(`${DB_URL}/usuarios.json`);
            const dUsr = await rUsr.json();
            if(dUsr) { dbU = Object.values(dUsr); localStorage.setItem("db_usuarios", JSON.stringify(dbU)); }
        } catch (e) { console.error("Error nube"); }
    }

    let dbU = JSON.parse(localStorage.getItem("db_usuarios")) || [];
    let dbR = JSON.parse(localStorage.getItem("db_registros")) || [];
    let user = JSON.parse(localStorage.getItem("sesion_activa"));
    let editId = null;

    function logout() { localStorage.removeItem("sesion_activa"); location.reload(); }
    function switchAuth(m) { 
        $('regFields').classList.toggle('hidden', m==='login'); 
        $('btnL').style.opacity = m==='login'?1:0.5; $('btnR').style.opacity = m==='reg'?1:0.5;
        $('btnMainAuth').innerText = m==='login' ? 'Acceder al Portal' : 'Finalizar Registro';
    }
    function toggleSec() { $('authCode').classList.toggle('hidden', $('authRol').value!=='pm' || $('regFields').classList.contains('hidden')); }

    function handleAuth() {
        const u=$('authUser').value.trim(), p=$('authPass').value, r=$('authRol').value, c=$('authCode').value;
        if(!u||!p) return alert("Complete los datos");
        if(!$('regFields').classList.contains('hidden')){
            if(dbU.find(x=>x.user===u)) return alert("Usuario ya existe");
            if(r==='pm'&&c!==PM_KEY) return alert("C√≥digo PM incorrecto");
            const newUser = {user:u,pass:p,rol:r,id:Date.now()};
            dbU.push(newUser); syncCloud('usuarios', newUser);
            alert("¬°Registrado!"); switchAuth('login');
        } else {
            const l=dbU.find(x=>x.user===u&&x.pass===p);
            if(!l) return alert("Credenciales incorrectas");
            user=l; localStorage.setItem("sesion_activa", JSON.stringify(l)); init();
        }
    }

    async function init() {
        if(user){
            await pullCloud();
            $('authModule').classList.add('hidden'); $('app').classList.remove('hidden');
            if(user.rol==='pm'){ $('pmTools').classList.remove('hidden'); fillIngs(); }
            else { $('chartIngBox').classList.add('hidden'); $('ingSel').innerHTML=`<option>${user.user}</option>`; $('ingSel').disabled=true; }
            render();
        }
    }

    function fillIngs() {
        const ings = dbU.filter(u=>u.rol==='ingeniero');
        let h = '<option value="">Seleccionar Ingeniero...</option>';
        ings.forEach(i=>h+=`<option value="${i.user}">${i.user}</option>`);
        $('ingSel').innerHTML=h; $('fIng').innerHTML='<option value="">Todos</option>'+h;
    }

    function actualizarSubmenu() {
        const principal = $('codProy').value;
        const sub = $('codPC');
        sub.innerHTML = '<option value="">C√≥digo P+C...</option>';
        let opciones = [];
        if (principal === "JNK-MLG-01") opciones = ["JNK-MLG-01-Gesti√≥n", "JNK-MLG-01-Ingenier√≠a", "JNK-MLG-01-MesaTrabajo", "JNK-MLG-01-Previos"];
        else if (principal === "EDF-BSL6") opciones = ["EDF-BSL6-Gesti√≥n", "EDF-BSL6-Ingenier√≠a", "EDF-BSL6-MesaTrabajo", "EDF-BSL6-Previos"];
        else if (principal === "ING") opciones = ["GST-ING", "OFC-ING", "CLD-ING", "OFT-ING", "CAP-ING", "LCC"];
        else if (principal !== "") opciones = [principal + "-P+C"];
        opciones.forEach(opt => {
            const el = document.createElement("option"); el.value = opt; el.innerText = opt; sub.appendChild(el);
        });
    }

    function save() {
        const proyectoFinal = `${$('codProy').value} | ${$('codPC').value}`;
        const r={id:editId||Date.now(),ing:$('ingSel').value,proy:proyectoFinal,fecha:$('fecha').value,horas:Number($('horas').value),act:$('act').value,desc:$('desc').value};
        if(!r.ing||!$('codProy').value||!$('codPC').value||!r.fecha||!r.horas||!r.act) return alert("Faltan datos");
        editId ? dbR=dbR.map(x=>x.id===editId?r:x) : dbR.push(r);
        localStorage.setItem("db_registros", JSON.stringify(dbR));
        syncCloud('actividades', r);
        editId=null; clean(); render();
    }

    function clean() { $('codProy').value=""; $('codPC').innerHTML='<option value="">C√≥digo P+C...</option>'; $('fecha').value=$('horas').value=$('act').value=$('desc').value=""; }

    function render() {
        let d = user.rol==='pm' ? [...dbR] : dbR.filter(r=>r.ing===user.user);
        if(user.rol==='pm'){
            if($('fIng').value) d=d.filter(r=>r.ing===$('fIng').value);
            if($('fProy').value) d=d.filter(r=>r.proy===$('fProy').value);
            if($('fD').value) d=d.filter(r=>r.fecha>=$('fD').value);
            if($('fH').value) d=d.filter(r=>r.fecha<=$('fH').value);
        }
        d.sort((a,b)=>new Date(a.fecha)-new Date(b.fecha));
        renderT(d); renderC(d); updateKPIs(d);
        if(user.rol==='pm') updateProyFilter();
    }

    function updateKPIs(d) {
        const porDia = d.reduce((acc, r) => { acc[r.fecha] = (acc[r.fecha]||0)+r.horas; return acc; }, {});
        const dias = Object.values(porDia);
        const total = d.reduce((a,b)=>a+b.horas,0);
        const metas = dias.filter(h=>h>=META).length;
        const proys = d.reduce((acc, r) => { acc[r.proy] = (acc[r.proy]||0)+1; return acc; }, {});
        const top = Object.keys(proys).length ? Object.keys(proys).reduce((a,b)=>proys[a]>proys[b]?a:b) : "-";
        $('kpiTotal').innerText = total.toFixed(1); $('kpiMeta').innerText = metas;
        $('kpiProy').innerText = top.substring(0,10); $('kpiEfi').innerText = dias.length ? ((metas/dias.length)*100).toFixed(0)+"%" : "0%";
    }

    function renderT(d) {
        let h="<table><tr><th>Ingeniero</th><th>Proyecto</th><th>Fecha</th><th>Horas</th><th>Actividad</th><th>Acciones</th></tr>";
        d.forEach(r=>{
            const c=r.horas>=META;
            h+=`<tr><td>${r.ing}</td><td>${r.proy}</td><td>${r.fecha}</td><td class="${c?'meta-cumplida':'meta-baja'}">${r.horas}h</td><td>${r.act}</td>
            <td><button onclick="editR(${r.id})" style="padding:5px; width:auto">‚úèÔ∏è</button><button onclick="delR(${r.id})" style="background:var(--danger);padding:5px; width:auto">üóëÔ∏è</button></td></tr>`;
        });
        $('tablaD').innerHTML=h+"</table>";
    }

    window.editR=id=>{ 
        const r=dbR.find(x=>x.id===id); $('ingSel').value=r.ing; 
        const p=r.proy.split(" | "); $('codProy').value=p[0]||""; actualizarSubmenu(); $('codPC').value=p[1]||"";
        $('fecha').value=r.fecha; $('horas').value=r.horas; $('act').value=r.act; $('desc').value=r.desc; editId=id; 
    };

    window.delR=async id=>{ 
        if(confirm("¬øBorrar?")){ 
            dbR=dbR.filter(x=>x.id!==id); localStorage.setItem("db_registros",JSON.stringify(dbR)); 
            await fetch(`${DB_URL}/actividades/${id}.json`, { method: 'DELETE' }); render(); 
        }
    };

    function draw(id, data, color, esL = false) {
        const c=$(id); if(!c) return;
        const ctx=c.getContext("2d"); ctx.clearRect(0,0,c.width,c.height);
        const ks=Object.keys(data), vs=Object.values(data); if(!ks.length) return;
        const max=Math.max(...vs, esL?META:1);
        if(esL){
            const step = (c.width-60)/(ks.length-1||1); const ym=c.height-(META/max*(c.height-60))-30;
            ctx.setLineDash([]); ctx.strokeStyle="rgba(255,75,43,0.4)"; ctx.beginPath(); ctx.moveTo(30,ym); ctx.lineTo(c.width-30,ym); ctx.stroke();
            ctx.strokeStyle=color; ctx.beginPath(); ctx.lineWidth=3;
            ks.forEach((k,i)=>{
                const x=30+i*step, y=c.height-(vs[i]/max*(c.height-60))-30;
                i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
                ctx.fillStyle=vs[i]>=META?"#2ecc71":"#ff4b2b"; ctx.fillRect(x-3,y-3,6,6);
            }); ctx.stroke();
        } else {
            const w=(c.width/ks.length)*0.5;
            ks.forEach((k,i)=>{
                const h=(vs[i]/max)*(c.height-60), x=i*(c.width/ks.length)+(c.width/ks.length-w)/2;
                ctx.fillStyle=color; ctx.fillRect(x,c.height-h-30,w,h);
                ctx.fillStyle="#fff"; ctx.font="9px Arial"; ctx.fillText(vs[i]+"h", x, c.height-h-35);
            });
        }
    }

    function renderC(d) {
        const s={ing:{}, proy:{}, act:{}, temp:{}};
        d.forEach(r=>{ s.ing[r.ing]=(s.ing[r.ing]||0)+r.horas; s.proy[r.proy]=(s.proy[r.proy]||0)+r.horas; s.act[r.act]=(s.act[r.act]||0)+r.horas; s.temp[r.fecha]=(s.temp[r.fecha]||0)+r.horas; });
        if(user.rol==='pm') draw("cIng", s.ing, "#4facfe");
        draw("cProy", s.proy, "#00f2fe"); draw("cAct", s.act, "#ffa502"); draw("cLine", s.temp, "#2ecc71", true);
        applyCanvaFX(d);
    }

    // --- GESTI√ìN DE DATOS ---
    function exportarBackup() {
        const dEx = { usuarios: user.rol==='pm'?dbU:[user], registros: user.rol==='pm'?dbR:dbR.filter(r=>r.ing===user.user) };
        const a = document.createElement("a"); a.href = URL.createObjectURL(new Blob([JSON.stringify(dEx,null,2)],{type:"application/json"}));
        a.download = `Backup_${user.user}.json`; a.click();
    }

    function importarBackup(e) {
        const f = e.target.files; if(!f) return;
        const r = new FileReader(); r.onload = (ev) => {
            try {
                const d = JSON.parse(ev.target.result);
                if(d.usuarios) d.usuarios.forEach(u=>{ if(!dbU.find(x=>x.user===u.user)) dbU.push(u); });
                if(d.registros) d.registros.forEach(re=>{ if(!dbR.find(x=>x.id===re.id)) dbR.push(re); });
                localStorage.setItem("db_usuarios", JSON.stringify(dbU));
                localStorage.setItem("db_registros", JSON.stringify(dbR));
                location.reload();
            } catch(e) { alert("Error JSON"); }
        }; r.readAsText(f);
    }

    // INYECCI√ìN QUIR√öRGICA: Limpiar tildes para Excel
    const limpiarTildes = (s) => s.normalize("NFD").replace(/[\u0300-\u036f]/g, "");

    function exportXLS() {
        let dr = user.rol==='pm' ? [...dbR] : dbR.filter(r=>r.ing===user.user);
        let h="<table border='1'><tr><th>Ingeniero</th><th>Proyecto</th><th>Fecha</th><th>Horas</th><th>Actividad</th></tr>";
        dr.forEach(r=> {
            h+=`<tr><td>${limpiarTildes(r.ing)}</td><td>${limpiarTildes(r.proy)}</td><td>${r.fecha}</td><td>${r.horas}</td><td>${limpiarTildes(r.act)}</td></tr>`;
        });
        const a = document.createElement("a"); a.href = URL.createObjectURL(new Blob([h],{type:"application/vnd.ms-excel"})); a.download=`Reporte_${user.user}.xls`; a.click();
    }

    function updateProyFilter() {
        const actual = $('fProy').value;
        const proys = [...new Set(dbR.map(r=>r.proy))];
        let h = '<option value="">Todos los Proyectos</option>';
        proys.forEach(p=>h+=`<option value="${p}" ${p===actual?'selected':''}>${p}</option>`);
        $('fProy').innerHTML=h;
    }

    // --- CAPA EST√âTICA ADICIONAL ---
    function applyCanvaFX(d) {
        const ovI = $('canvaIng'); const ovS = $('canvaS'); if(!ovI) return;
        const tot = d.reduce((s,r)=>s+r.horas, 0);
        const mapI = d.reduce((acc,r)=>{ acc[r.ing]=(acc[r.ing]||0)+r.horas; return acc; }, {});
        ovI.innerHTML = Object.entries(mapI).sort((a,b)=>b-a).slice(0,4).map(([n,h])=>`
            <div class="canva-badge"><span class="canva-name">${n}</span><span class="canva-pct">${((h/tot)*100).toFixed(1)}%</span></div>`).join('');
        const fechs = d.reduce((acc,r)=>{ acc[r.fecha]=(acc[r.fecha]||0)+r.horas; return acc; },{});
        const ks = Object.keys(fechs).sort();
        let ac = 0; const ds = {}; ks.forEach(k=>{ ac+=fechs[k]; ds[k]=ac; });
        draw("cLine", ds, "rgba(79, 172, 254, 0.5)", true);
        ovS.innerHTML = `<div class="canva-badge" style="border-left:3px solid var(--secondary)"><span class="canva-name">Acumulado</span><span class="canva-pct" style="background:var(--secondary)">${ac.toFixed(1)}h</span></div>`;
    }

    init();
</script>
</body>
</html>














